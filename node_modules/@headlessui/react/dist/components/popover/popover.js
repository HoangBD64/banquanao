"use client";import{useFocusRing as Re}from"@react-aria/focus";import{useHover as Oe}from"@react-aria/interactions";import g,{createContext as Z,createRef as pe,useContext as ee,useEffect as te,useMemo as G,useReducer as Ce,useRef as q,useState as ye}from"react";import{useActivePress as Fe}from'../../hooks/use-active-press.js';import{useElementSize as Me}from'../../hooks/use-element-size.js';import{useEvent as R}from'../../hooks/use-event.js';import{useEventListener as _e}from'../../hooks/use-event-listener.js';import{useId as oe}from'../../hooks/use-id.js';import{useIsoMorphicEffect as xe}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ee}from'../../hooks/use-latest-value.js';import{useOnDisappear as Le}from'../../hooks/use-on-disappear.js';import{useOutsideClick as Ie}from'../../hooks/use-outside-click.js';import{useOwnerDocument as se}from'../../hooks/use-owner.js';import{useResolveButtonType as Be}from'../../hooks/use-resolve-button-type.js';import{useMainTreeNode as he,useRootContainers as De}from'../../hooks/use-root-containers.js';import{useScrollLock as Ge}from'../../hooks/use-scroll-lock.js';import{optionalRef as He,useSyncRefs as X}from'../../hooks/use-sync-refs.js';import{Direction as U,useTabDirection as be}from'../../hooks/use-tab-direction.js';import{CloseProvider as Ne}from'../../internal/close-provider.js';import{FloatingProvider as Ue,useFloatingPanel as ke,useFloatingPanelProps as we,useFloatingReference as We,useResolvedAnchor as Ve}from'../../internal/floating.js';import{Hidden as ue,HiddenFeatures as ie}from'../../internal/hidden.js';import{OpenClosedProvider as je,State as Y,useOpenClosed as ge}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Se}from'../../utils/bugs.js';import{Focus as k,FocusResult as fe,FocusableMode as Ke,focusIn as w,getFocusableElements as Pe,isFocusableElement as $e}from'../../utils/focus-management.js';import{match as W}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as Je}from'../../utils/owner.js';import{RenderFeatures as re,forwardRefWithAs as z,mergeProps as de,render as Q,useMergeRefsFn as Xe}from'../../utils/render.js';import{Keys as V}from'../keyboard.js';import{Portal as Ye,useNestedPortals as qe}from'../portal/portal.js';var ze=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(ze||{}),Qe=(i=>(i[i.TogglePopover=0]="TogglePopover",i[i.ClosePopover=1]="ClosePopover",i[i.SetButton=2]="SetButton",i[i.SetButtonId=3]="SetButtonId",i[i.SetPanel=4]="SetPanel",i[i.SetPanelId=5]="SetPanelId",i))(Qe||{});let Ze={[0]:t=>({...t,popoverState:W(t.popoverState,{[0]:1,[1]:0}),__demoMode:!1}),[1](t){return t.popoverState===1?t:{...t,popoverState:1,__demoMode:!1}},[2](t,a){return t.button===a.button?t:{...t,button:a.button}},[3](t,a){return t.buttonId===a.buttonId?t:{...t,buttonId:a.buttonId}},[4](t,a){return t.panel===a.panel?t:{...t,panel:a.panel}},[5](t,a){return t.panelId===a.panelId?t:{...t,panelId:a.panelId}}},ce=Z(null);ce.displayName="PopoverContext";function ne(t){let a=ee(ce);if(a===null){let u=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,ne),u}return a}let le=Z(null);le.displayName="PopoverAPIContext";function ve(t){let a=ee(le);if(a===null){let u=new Error(`<${t} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,ve),u}return a}let Te=Z(null);Te.displayName="PopoverGroupContext";function Ae(){return ee(Te)}let ae=Z(null);ae.displayName="PopoverPanelContext";function et(){return ee(ae)}function tt(t,a){return W(a.type,Ze,t,a)}let ot="div";function rt(t,a){var E;let{__demoMode:u=!1,...C}=t,T=q(null),S=X(a,He(o=>{T.current=o})),i=q([]),l=Ce(tt,{__demoMode:u,popoverState:u?0:1,buttons:i,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:pe(),afterPanelSentinel:pe(),afterButtonSentinel:pe()}),[{popoverState:f,button:e,buttonId:P,panel:v,panelId:M,beforePanelSentinel:m,afterPanelSentinel:j,afterButtonSentinel:n},s]=l,y=se((E=T.current)!=null?E:e),_=G(()=>{if(!e||!v)return!1;for(let b of document.querySelectorAll("body > *"))if(Number(b==null?void 0:b.contains(e))^Number(b==null?void 0:b.contains(v)))return!0;let o=Pe(),p=o.indexOf(e),B=(p+o.length-1)%o.length,r=(p+1)%o.length,d=o[B],A=o[r];return!v.contains(d)&&!v.contains(A)},[e,v]),x=Ee(P),h=Ee(M),F=G(()=>({buttonId:x,panelId:h,close:()=>s({type:1})}),[x,h,s]),O=Ae(),D=O==null?void 0:O.registerPopover,L=R(()=>{var o;return(o=O==null?void 0:O.isFocusWithinPopoverGroup())!=null?o:(y==null?void 0:y.activeElement)&&((e==null?void 0:e.contains(y.activeElement))||(v==null?void 0:v.contains(y.activeElement)))});te(()=>D==null?void 0:D(F),[D,F]);let[K,$]=qe(),H=De({mainTreeNodeRef:O==null?void 0:O.mainTreeNodeRef,portals:K,defaultContainers:[e,v]});_e(y==null?void 0:y.defaultView,"focus",o=>{var p,B,r,d,A,b;o.target!==window&&o.target instanceof HTMLElement&&f===0&&(L()||e&&v&&(H.contains(o.target)||(B=(p=m.current)==null?void 0:p.contains)!=null&&B.call(p,o.target)||(d=(r=j.current)==null?void 0:r.contains)!=null&&d.call(r,o.target)||(b=(A=n.current)==null?void 0:A.contains)!=null&&b.call(A,o.target)||s({type:1})))},!0),Ie(H.resolveContainers,(o,p)=>{s({type:1}),$e(p,Ke.Loose)||(o.preventDefault(),e==null||e.focus())},f===0);let I=R(o=>{s({type:1});let p=(()=>o?o instanceof HTMLElement?o:"current"in o&&o.current instanceof HTMLElement?o.current:e:e)();p==null||p.focus()}),J=G(()=>({close:I,isPortalled:_}),[I,_]),N=G(()=>({open:f===0,close:I}),[f,I]),c={ref:S};return g.createElement(Ue,null,g.createElement(ae.Provider,{value:null},g.createElement(ce.Provider,{value:l},g.createElement(le.Provider,{value:J},g.createElement(Ne,{value:I},g.createElement(je,{value:W(f,{[0]:Y.Open,[1]:Y.Closed})},g.createElement($,null,Q({ourProps:c,theirProps:C,slot:N,defaultTag:ot,name:"Popover"}),g.createElement(H.MainTreeNode,null))))))))}let nt="button";function lt(t,a){let u=oe(),{id:C=`headlessui-popover-button-${u}`,disabled:T=!1,autoFocus:S=!1,...i}=t,[l,f]=ne("Popover.Button"),{isPortalled:e}=ve("Popover.Button"),P=q(null),v=`headlessui-focus-sentinel-${oe()}`,M=Ae(),m=M==null?void 0:M.closeOthers,n=et()!==null;te(()=>{if(!n)return f({type:3,buttonId:C}),()=>{f({type:3,buttonId:null})}},[n,C,f]);let[s]=ye(()=>Symbol()),y=X(P,a,We(),n?null:r=>{if(r)l.buttons.current.push(s);else{let d=l.buttons.current.indexOf(s);d!==-1&&l.buttons.current.splice(d,1)}l.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),r&&f({type:2,button:r})}),_=X(P,a),x=se(P),h=R(r=>{var d,A,b;if(n){if(l.popoverState===1)return;switch(r.key){case V.Space:case V.Enter:r.preventDefault(),(A=(d=r.target).click)==null||A.call(d),f({type:1}),(b=l.button)==null||b.focus();break}}else switch(r.key){case V.Space:case V.Enter:r.preventDefault(),r.stopPropagation(),l.popoverState===1&&(m==null||m(l.buttonId)),f({type:0});break;case V.Escape:if(l.popoverState!==0)return m==null?void 0:m(l.buttonId);if(!P.current||x!=null&&x.activeElement&&!P.current.contains(x.activeElement))return;r.preventDefault(),r.stopPropagation(),f({type:1});break}}),F=R(r=>{n||r.key===V.Space&&r.preventDefault()}),O=R(r=>{var d,A;Se(r.currentTarget)||T||(n?(f({type:1}),(d=l.button)==null||d.focus()):(r.preventDefault(),r.stopPropagation(),l.popoverState===1&&(m==null||m(l.buttonId)),f({type:0}),(A=l.button)==null||A.focus()))}),D=R(r=>{r.preventDefault(),r.stopPropagation()}),{isFocusVisible:L,focusProps:K}=Re({autoFocus:S}),{isHovered:$,hoverProps:H}=Oe({isDisabled:T}),{pressed:I,pressProps:J}=Fe({disabled:T}),N=l.popoverState===0,c=G(()=>({open:N,active:I||N,disabled:T,hover:$,focus:L,autofocus:S}),[N,$,L,I,T,S]),E=Be(t,P),o=n?de({ref:_,type:E,onKeyDown:h,onClick:O,disabled:T||void 0,autoFocus:S},K,H,J):de({ref:y,id:l.buttonId,type:E,"aria-expanded":l.popoverState===0,"aria-controls":l.panel?l.panelId:void 0,disabled:T||void 0,autoFocus:S,onKeyDown:h,onKeyUp:F,onClick:O,onMouseDown:D},K,H,J),p=be(),B=R(()=>{let r=l.panel;if(!r)return;function d(){W(p.current,{[U.Forwards]:()=>w(r,k.First),[U.Backwards]:()=>w(r,k.Last)})===fe.Error&&w(Pe().filter(b=>b.dataset.headlessuiFocusGuard!=="true"),W(p.current,{[U.Forwards]:k.Next,[U.Backwards]:k.Previous}),{relativeTo:l.button})}d()});return g.createElement(g.Fragment,null,Q({ourProps:o,theirProps:i,slot:c,defaultTag:nt,name:"Popover.Button"}),N&&!n&&e&&g.createElement(ue,{id:v,ref:l.afterButtonSentinel,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:B}))}let at="div",pt=re.RenderStrategy|re.Static;function st(t,a){let u=oe(),{id:C=`headlessui-popover-overlay-${u}`,...T}=t,[{popoverState:S},i]=ne("Popover.Overlay"),l=X(a),f=ge(),e=(()=>f!==null?(f&Y.Open)===Y.Open:S===0)(),P=R(m=>{if(Se(m.currentTarget))return m.preventDefault();i({type:1})}),v=G(()=>({open:S===0}),[S]);return Q({ourProps:{ref:l,id:C,"aria-hidden":!0,onClick:P},theirProps:T,slot:v,defaultTag:at,features:pt,visible:e,name:"Popover.Overlay"})}let ut="div",it=re.RenderStrategy|re.Static;function ft(t,a){let u=oe(),{id:C=`headlessui-popover-panel-${u}`,focus:T=!1,anchor:S,portal:i=!1,modal:l=!1,...f}=t,[e,P]=ne("Popover.Panel"),{close:v,isPortalled:M}=ve("Popover.Panel"),m=`headlessui-focus-sentinel-before-${u}`,j=`headlessui-focus-sentinel-after-${u}`,n=q(null),s=Ve(S),[y,_]=ke(s),x=we();s&&(i=!0);let h=X(n,a,s?y:null,c=>{P({type:4,panel:c})}),F=se(n),O=Xe();xe(()=>(P({type:5,panelId:C}),()=>{P({type:5,panelId:null})}),[C,P]);let D=ge(),L=(()=>D!==null?(D&Y.Open)===Y.Open:e.popoverState===0)();Le(e.button,()=>P({type:1}),L),Ge(F,e.__demoMode?!1:l&&L);let K=R(c=>{var E;switch(c.key){case V.Escape:if(e.popoverState!==0||!n.current||F!=null&&F.activeElement&&!n.current.contains(F.activeElement))return;c.preventDefault(),c.stopPropagation(),P({type:1}),(E=e.button)==null||E.focus();break}});te(()=>{var c;t.static||e.popoverState===1&&((c=t.unmount)==null||c)&&P({type:4,panel:null})},[e.popoverState,t.unmount,t.static,P]),te(()=>{if(e.__demoMode||!T||e.popoverState!==0||!n.current)return;let c=F==null?void 0:F.activeElement;n.current.contains(c)||w(n.current,k.First)},[e.__demoMode,T,n,e.popoverState]);let $=G(()=>({open:e.popoverState===0,close:v}),[e,v]),H=de(s?x():{},{ref:h,id:C,onKeyDown:K,onBlur:T&&e.popoverState===0?c=>{var o,p,B,r,d;let E=c.relatedTarget;E&&n.current&&((o=n.current)!=null&&o.contains(E)||(P({type:1}),((B=(p=e.beforePanelSentinel.current)==null?void 0:p.contains)!=null&&B.call(p,E)||(d=(r=e.afterPanelSentinel.current)==null?void 0:r.contains)!=null&&d.call(r,E))&&E.focus({preventScroll:!0})))}:void 0,tabIndex:-1,style:{..._,"--button-width":Me(e.button,!0).width}}),I=be(),J=R(()=>{let c=n.current;if(!c)return;function E(){W(I.current,{[U.Forwards]:()=>{var p;w(c,k.First)===fe.Error&&((p=e.afterPanelSentinel.current)==null||p.focus())},[U.Backwards]:()=>{var o;(o=e.button)==null||o.focus({preventScroll:!0})}})}E()}),N=R(()=>{let c=n.current;if(!c)return;function E(){W(I.current,{[U.Forwards]:()=>{var A;if(!e.button)return;let o=Pe(),p=o.indexOf(e.button),B=o.slice(0,p+1),d=[...o.slice(p+1),...B];for(let b of d.slice())if(b.dataset.headlessuiFocusGuard==="true"||(A=e.panel)!=null&&A.contains(b)){let me=d.indexOf(b);me!==-1&&d.splice(me,1)}w(d,k.First,{sorted:!1})},[U.Backwards]:()=>{var p;w(c,k.Previous)===fe.Error&&((p=e.button)==null||p.focus())}})}E()});return g.createElement(ae.Provider,{value:C},g.createElement(le.Provider,{value:{close:v,isPortalled:M}},g.createElement(Ye,{enabled:i?t.static||L:!1},L&&M&&g.createElement(ue,{id:m,ref:e.beforePanelSentinel,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:J}),Q({mergeRefs:O,ourProps:H,theirProps:f,slot:$,defaultTag:ut,features:it,visible:L,name:"Popover.Panel"}),L&&M&&g.createElement(ue,{id:j,ref:e.afterPanelSentinel,features:ie.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:N}))))}let Pt="div";function dt(t,a){let u=q(null),C=X(u,a),[T,S]=ye([]),i=he(),l=R(n=>{S(s=>{let y=s.indexOf(n);if(y!==-1){let _=s.slice();return _.splice(y,1),_}return s})}),f=R(n=>(S(s=>[...s,n]),()=>l(n))),e=R(()=>{var y;let n=Je(u);if(!n)return!1;let s=n.activeElement;return(y=u.current)!=null&&y.contains(s)?!0:T.some(_=>{var x,h;return((x=n.getElementById(_.buttonId.current))==null?void 0:x.contains(s))||((h=n.getElementById(_.panelId.current))==null?void 0:h.contains(s))})}),P=R(n=>{for(let s of T)s.buttonId.current!==n&&s.close()}),v=G(()=>({registerPopover:f,unregisterPopover:l,isFocusWithinPopoverGroup:e,closeOthers:P,mainTreeNodeRef:i.mainTreeNodeRef}),[f,l,e,P,i.mainTreeNodeRef]),M=G(()=>({}),[]),m=t,j={ref:C};return g.createElement(Te.Provider,{value:v},Q({ourProps:j,theirProps:m,slot:M,defaultTag:Pt,name:"Popover.Group"}),g.createElement(i.MainTreeNode,null))}let ct=z(rt),vt=z(lt),Tt=z(st),mt=z(ft),yt=z(dt),qt=Object.assign(ct,{Button:vt,Overlay:Tt,Panel:mt,Group:yt});export{qt as Popover,vt as PopoverButton,yt as PopoverGroup,Tt as PopoverOverlay,mt as PopoverPanel};
