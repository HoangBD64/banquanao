"use client";import{useFocusRing as Pe}from"@react-aria/focus";import{useHover as Ae}from"@react-aria/interactions";import D,{Fragment as pe,createContext as ee,createRef as Ee,useCallback as ue,useContext as te,useEffect as de,useMemo as k,useReducer as he,useRef as V,useState as De}from"react";import{useActivePress as _e}from'../../hooks/use-active-press.js';import{useByComparator as Ie}from'../../hooks/use-by-comparator.js';import{useComputed as Ce}from'../../hooks/use-computed.js';import{useControllable as Fe}from'../../hooks/use-controllable.js';import{useDefaultValue as Me}from'../../hooks/use-default-value.js';import{useDidElementMove as we}from'../../hooks/use-did-element-move.js';import{useDisposables as X}from'../../hooks/use-disposables.js';import{useElementSize as Be}from'../../hooks/use-element-size.js';import{useEvent as f}from'../../hooks/use-event.js';import{useId as oe}from'../../hooks/use-id.js';import{useInertOthers as ke}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as ne}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ue}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ne}from'../../hooks/use-on-disappear.js';import{useOutsideClick as Ge}from'../../hooks/use-outside-click.js';import{useOwnerDocument as Ve}from'../../hooks/use-owner.js';import{useResolveButtonType as He}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as Ke}from'../../hooks/use-scroll-lock.js';import{useSyncRefs as K}from'../../hooks/use-sync-refs.js';import{useTextValue as je}from'../../hooks/use-text-value.js';import{useTrackedPointer as ze}from'../../hooks/use-tracked-pointer.js';import{useDisabled as We}from'../../internal/disabled.js';import{FloatingProvider as Qe,useFloatingPanel as Xe,useFloatingPanelProps as Je,useFloatingReference as $e,useFloatingReferenceProps as qe,useResolvedAnchor as Ye}from'../../internal/floating.js';import{FormFields as Ze}from'../../internal/form-fields.js';import{useProvidedId as et}from'../../internal/id.js';import{OpenClosedProvider as tt,State as J,useOpenClosed as ot}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as nt}from'../../utils/bugs.js';import{Focus as m,calculateActiveIndex as ie}from'../../utils/calculate-active-index.js';import{disposables as re}from'../../utils/disposables.js';import{FocusableMode as it,isFocusableElement as rt,sortByDomNode as at}from'../../utils/focus-management.js';import{attemptSubmit as lt}from'../../utils/form.js';import{match as H}from'../../utils/match.js';import{getOwnerDocument as st}from'../../utils/owner.js';import{RenderFeatures as ce,forwardRefWithAs as j,mergeProps as fe,render as z}from'../../utils/render.js';import{useDescribedBy as pt}from'../description/description.js';import{Keys as S}from'../keyboard.js';import{Label as ut,useLabelledBy as dt,useLabels as ct}from'../label/label.js';import{Portal as ft}from'../portal/portal.js';var bt=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(bt||{}),Tt=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(Tt||{}),xt=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(xt||{}),mt=(i=>(i[i.OpenListbox=0]="OpenListbox",i[i.CloseListbox=1]="CloseListbox",i[i.GoToOption=2]="GoToOption",i[i.Search=3]="Search",i[i.ClearSearch=4]="ClearSearch",i[i.RegisterOption=5]="RegisterOption",i[i.UnregisterOption=6]="UnregisterOption",i))(mt||{});function ae(e,a=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,n=at(a(e.options.slice()),T=>T.dataRef.current.domRef.current),u=o?n.indexOf(o):null;return u===-1&&(u=null),{options:n,activeOptionIndex:u}}let Ot={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1,__demoMode:!1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let a=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,n=e.options.findIndex(u=>o(u.dataRef.current.value));return n!==-1&&(a=n),{...e,listboxState:0,activeOptionIndex:a,__demoMode:!1}},[2](e,a){var T,O,i,l,t;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(T=a.trigger)!=null?T:1,__demoMode:!1};if(a.focus===m.Nothing)return{...o,activeOptionIndex:null};if(a.focus===m.Specific)return{...o,activeOptionIndex:e.options.findIndex(r=>r.id===a.id)};if(a.focus===m.Previous){let r=e.activeOptionIndex;if(r!==null){let R=e.options[r].dataRef.current.domRef,c=ie(a,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});if(c!==null){let d=e.options[c].dataRef.current.domRef;if(((O=R.current)==null?void 0:O.previousElementSibling)===d.current||((i=d.current)==null?void 0:i.previousElementSibling)===null)return{...o,activeOptionIndex:c}}}}else if(a.focus===m.Next){let r=e.activeOptionIndex;if(r!==null){let R=e.options[r].dataRef.current.domRef,c=ie(a,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:d=>d.id,resolveDisabled:d=>d.dataRef.current.disabled});if(c!==null){let d=e.options[c].dataRef.current.domRef;if(((l=R.current)==null?void 0:l.nextElementSibling)===d.current||((t=d.current)==null?void 0:t.nextElementSibling)===null)return{...o,activeOptionIndex:c}}}}let n=ae(e),u=ie(a,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:r=>r.id,resolveDisabled:r=>r.dataRef.current.disabled});return{...o,...n,activeOptionIndex:u}},[3]:(e,a)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let n=e.searchQuery!==""?0:1,u=e.searchQuery+a.value.toLowerCase(),O=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+n).concat(e.options.slice(0,e.activeOptionIndex+n)):e.options).find(l=>{var t;return!l.dataRef.current.disabled&&((t=l.dataRef.current.textValue)==null?void 0:t.startsWith(u))}),i=O?e.options.indexOf(O):-1;return i===-1||i===e.activeOptionIndex?{...e,searchQuery:u}:{...e,searchQuery:u,activeOptionIndex:i,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,a)=>{let o={id:a.id,dataRef:a.dataRef},n=ae(e,u=>[...u,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(a.dataRef.current.value)&&(n.activeOptionIndex=n.options.indexOf(o)),{...e,...n}},[6]:(e,a)=>{let o=ae(e,n=>{let u=n.findIndex(T=>T.id===a.id);return u!==-1&&n.splice(u,1),n});return{...e,...o,activationTrigger:1}}},le=ee(null);le.displayName="ListboxActionsContext";function $(e){let a=te(le);if(a===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,$),o}return a}let q=ee(null);q.displayName="ListboxDataContext";function W(e){let a=te(q);if(a===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,W),o}return a}function yt(e,a){return H(a.type,Ot,e,a)}let vt=pe;function gt(e,a){var se;let o=We(),{value:n,defaultValue:u,form:T,name:O,onChange:i,by:l,invalid:t=!1,disabled:r=o||!1,horizontal:R=!1,multiple:c=!1,__demoMode:d=!1,...E}=e;const U=R?"horizontal":"vertical";let w=K(a),_=Me(u),[g=c?[]:void 0,y]=Fe(n,i,_),[I,v]=he(yt,{dataRef:Ee(),listboxState:d?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1,__demoMode:d}),B=V({static:!1,hold:!1}),M=V(null),x=V(null),A=V(new Map),h=Ie(l),N=ue(b=>H(p.mode,{[1]:()=>g.some(L=>h(L,b)),[0]:()=>h(g,b)}),[g]),p=k(()=>({...I,value:g,disabled:r,invalid:t,mode:c?1:0,orientation:U,compare:h,isSelected:N,optionsPropsRef:B,buttonRef:M,optionsRef:x,listRef:A}),[g,r,t,c,I,A]);ne(()=>{I.dataRef.current=p},[p]),Ge([p.buttonRef,p.optionsRef],(b,L)=>{var F;v({type:1}),rt(L,it.Loose)||(b.preventDefault(),(F=p.buttonRef.current)==null||F.focus())},p.listboxState===0);let G=k(()=>({open:p.listboxState===0,disabled:r,invalid:t,value:g}),[p,r,g,t]),Y=f(b=>{let L=p.options.find(F=>F.id===b);L&&Z(L.dataRef.current.value)}),Q=f(()=>{if(p.activeOptionIndex!==null){let{dataRef:b,id:L}=p.options[p.activeOptionIndex];Z(b.current.value),v({type:2,focus:m.Specific,id:L})}}),s=f(()=>v({type:0})),P=f(()=>v({type:1})),C=X(),Te=f((b,L,F)=>{C.dispose(),C.microTask(()=>b===m.Specific?v({type:2,focus:m.Specific,id:L,trigger:F}):v({type:2,focus:b,trigger:F}))}),xe=f((b,L)=>(v({type:5,id:b,dataRef:L}),()=>v({type:6,id:b}))),Z=f(b=>H(p.mode,{[0](){return y==null?void 0:y(b)},[1](){let L=p.value.slice(),F=L.findIndex(Re=>h(Re,b));return F===-1?L.push(b):L.splice(F,1),y==null?void 0:y(L)}})),me=f(b=>v({type:3,value:b})),Oe=f(()=>v({type:4})),ye=k(()=>({onChange:Z,registerOption:xe,goToOption:Te,closeListbox:P,openListbox:s,selectActiveOption:Q,selectOption:Y,search:me,clearSearch:Oe}),[]),[ve,ge]=ct({inherit:!0}),Le={ref:w},Se=ue(()=>{if(_!==void 0)return y==null?void 0:y(_)},[y,_]);return D.createElement(ge,{value:ve,props:{htmlFor:(se=p.buttonRef.current)==null?void 0:se.id},slot:{open:p.listboxState===0,disabled:r}},D.createElement(Qe,null,D.createElement(le.Provider,{value:ye},D.createElement(q.Provider,{value:p},D.createElement(tt,{value:H(p.listboxState,{[0]:J.Open,[1]:J.Closed})},O!=null&&g!=null&&D.createElement(Ze,{disabled:r,data:{[O]:g},form:T,onReset:Se}),z({ourProps:Le,theirProps:E,slot:G,defaultTag:vt,name:"Listbox"}))))))}let Lt="button";function St(e,a){var N;let o=W("Listbox.Button"),n=$("Listbox.Button"),u=oe(),T=et(),{id:O=T||`headlessui-listbox-button-${u}`,disabled:i=o.disabled||!1,autoFocus:l=!1,...t}=e,r=K(o.buttonRef,a,$e()),R=qe(),c=X(),d=f(p=>{switch(p.key){case S.Enter:lt(p.currentTarget);break;case S.Space:case S.ArrowDown:p.preventDefault(),n.openListbox(),c.nextFrame(()=>{o.value||n.goToOption(m.First)});break;case S.ArrowUp:p.preventDefault(),n.openListbox(),c.nextFrame(()=>{o.value||n.goToOption(m.Last)});break}}),E=f(p=>{switch(p.key){case S.Space:p.preventDefault();break}}),U=f(p=>{if(nt(p.currentTarget))return p.preventDefault();o.listboxState===0?(n.closeListbox(),c.nextFrame(()=>{var G;return(G=o.buttonRef.current)==null?void 0:G.focus({preventScroll:!0})})):(p.preventDefault(),n.openListbox())}),w=f(p=>p.preventDefault()),_=dt([O]),g=pt(),{isFocusVisible:y,focusProps:I}=Pe({autoFocus:l}),{isHovered:v,hoverProps:B}=Ae({isDisabled:i}),{pressed:M,pressProps:x}=_e({disabled:i}),A=k(()=>({open:o.listboxState===0,active:M||o.listboxState===0,disabled:i,invalid:o.invalid,value:o.value,hover:v,focus:y,autofocus:l}),[o.listboxState,o.value,i,v,y,M,o.invalid,l]),h=fe(R(),{ref:r,id:O,type:He(e,o.buttonRef),"aria-haspopup":"listbox","aria-controls":(N=o.optionsRef.current)==null?void 0:N.id,"aria-expanded":o.listboxState===0,"aria-labelledby":_,"aria-describedby":g,disabled:i||void 0,autoFocus:l,onKeyDown:d,onKeyUp:E,onKeyPress:w,onClick:U},I,B,x);return z({ourProps:h,theirProps:t,slot:A,defaultTag:Lt,name:"Listbox.Button"})}let be=ee(!1),Rt="div",Pt=ce.RenderStrategy|ce.Static;function At(e,a){var Q;let o=oe(),{id:n=`headlessui-listbox-options-${o}`,anchor:u,portal:T=!1,modal:O=!0,...i}=e,l=Ye(u);l&&(T=!0);let t=W("Listbox.Options"),r=$("Listbox.Options"),R=Ve(t.optionsRef),c=ot(),d=(()=>c!==null?(c&J.Open)===J.Open:t.listboxState===0)();Ne(t.buttonRef,r.closeListbox,d),Ke(R,t.__demoMode?!1:O&&t.listboxState===0),ke({allowed:f(()=>[t.buttonRef.current,t.optionsRef.current])},t.__demoMode?!1:O&&t.listboxState===0);let E=V(null);de(()=>{var P;if(!((P=l==null?void 0:l.to)!=null&&P.includes("selection")))return;if(!d){E.current=null;return}let s=Array.from(t.listRef.current.values());E.current=s.findIndex(C=>(C==null?void 0:C.dataset.selected)===""),E.current===-1&&(E.current=s.findIndex(C=>(C==null?void 0:C.dataset.disabled)===void 0),r.goToOption(m.First))},[d,t.listRef]);let w=we(t.buttonRef,t.listboxState!==0)?!1:d,_=(()=>{if(l==null)return;if(t.listRef.current.size<=0)return{...l,inner:void 0};let s=Array.from(t.listRef.current.values());return{...l,inner:{listRef:{current:s},index:E.current}}})(),[g,y]=Xe(_),I=Je(),v=K(t.optionsRef,a,l?g:null),B=X(),M=X();de(()=>{var P;let s=t.optionsRef.current;s&&t.listboxState===0&&s!==((P=st(s))==null?void 0:P.activeElement)&&(s==null||s.focus({preventScroll:!0}))},[t.listboxState,t.optionsRef,t.optionsRef.current]);let x=f(s=>{switch(M.dispose(),s.key){case S.Space:if(t.searchQuery!=="")return s.preventDefault(),s.stopPropagation(),r.search(s.key);case S.Enter:if(s.preventDefault(),s.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:P}=t.options[t.activeOptionIndex];r.onChange(P.current.value)}t.mode===0&&(r.closeListbox(),re().nextFrame(()=>{var P;return(P=t.buttonRef.current)==null?void 0:P.focus({preventScroll:!0})}));break;case H(t.orientation,{vertical:S.ArrowDown,horizontal:S.ArrowRight}):return s.preventDefault(),s.stopPropagation(),r.goToOption(m.Next);case H(t.orientation,{vertical:S.ArrowUp,horizontal:S.ArrowLeft}):return s.preventDefault(),s.stopPropagation(),r.goToOption(m.Previous);case S.Home:case S.PageUp:return s.preventDefault(),s.stopPropagation(),r.goToOption(m.First);case S.End:case S.PageDown:return s.preventDefault(),s.stopPropagation(),r.goToOption(m.Last);case S.Escape:return s.preventDefault(),s.stopPropagation(),r.closeListbox(),B.nextFrame(()=>{var P;return(P=t.buttonRef.current)==null?void 0:P.focus({preventScroll:!0})});case S.Tab:s.preventDefault(),s.stopPropagation();break;default:s.key.length===1&&(r.search(s.key),M.setTimeout(()=>r.clearSearch(),350));break}}),A=Ce(()=>{var s;return(s=t.buttonRef.current)==null?void 0:s.id},[t.buttonRef.current]),h=k(()=>({open:t.listboxState===0}),[t]),N=fe(l?I():{},{id:n,ref:v,"aria-activedescendant":t.activeOptionIndex===null||(Q=t.options[t.activeOptionIndex])==null?void 0:Q.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":A,"aria-orientation":t.orientation,onKeyDown:x,role:"listbox",tabIndex:0,style:{...y,"--button-width":Be(t.buttonRef,!0).width}}),[p,G]=De(t.value);t.value!==p&&t.listboxState===0&&t.mode!==1&&G(t.value);let Y=f(s=>t.compare(p,s));return D.createElement(ft,{enabled:T?e.static||d:!1},D.createElement(q.Provider,{value:t.mode===1?t:{...t,isSelected:Y}},z({ourProps:N,theirProps:i,slot:h,defaultTag:Rt,features:Pt,visible:w,name:"Listbox.Options"})))}let Et="div";function ht(e,a){let o=oe(),{id:n=`headlessui-listbox-option-${o}`,disabled:u=!1,value:T,...O}=e,i=te(be)===!0,l=W("Listbox.Option"),t=$("Listbox.Option"),r=l.activeOptionIndex!==null?l.options[l.activeOptionIndex].id===n:!1,R=l.isSelected(T),c=V(null),d=je(c),E=Ue({disabled:u,value:T,domRef:c,get textValue(){return d()}}),U=K(a,c,x=>{x?l.listRef.current.set(n,x):l.listRef.current.delete(n)});ne(()=>{if(l.__demoMode||l.listboxState!==0||!r||l.activationTrigger===0)return;let x=re();return x.requestAnimationFrame(()=>{var A,h;(h=(A=c.current)==null?void 0:A.scrollIntoView)==null||h.call(A,{block:"nearest"})}),x.dispose},[c,r,l.__demoMode,l.listboxState,l.activationTrigger,l.activeOptionIndex]),ne(()=>{if(!i)return t.registerOption(n,E)},[E,n,i]);let w=f(x=>{if(u)return x.preventDefault();t.onChange(T),l.mode===0&&(t.closeListbox(),re().nextFrame(()=>{var A;return(A=l.buttonRef.current)==null?void 0:A.focus({preventScroll:!0})}))}),_=f(()=>{if(u)return t.goToOption(m.Nothing);t.goToOption(m.Specific,n)}),g=ze(),y=f(x=>{g.update(x),!u&&(r||t.goToOption(m.Specific,n,0))}),I=f(x=>{g.wasMoved(x)&&(u||r||t.goToOption(m.Specific,n,0))}),v=f(x=>{g.wasMoved(x)&&(u||r&&t.goToOption(m.Nothing))}),B=k(()=>({active:r,focus:r,selected:R,disabled:u,selectedOption:R&&i}),[r,R,u,i]),M=i?{}:{id:n,ref:U,role:"option",tabIndex:u===!0?void 0:-1,"aria-disabled":u===!0?!0:void 0,"aria-selected":R,disabled:void 0,onClick:w,onFocus:_,onPointerEnter:y,onMouseEnter:y,onPointerMove:I,onMouseMove:I,onPointerLeave:v,onMouseLeave:v};return!R&&i?null:z({ourProps:M,theirProps:O,slot:B,defaultTag:Et,name:"Listbox.Option"})}let Dt=pe;function _t(e,a){let{options:o,placeholder:n,...u}=e,O={ref:K(a)},i=W("ListboxSelectedOption"),l=k(()=>({}),[]),t=i.value===void 0||i.value===null||i.mode===1&&Array.isArray(i.value)&&i.value.length===0;return D.createElement(be.Provider,{value:!0},z({ourProps:O,theirProps:{...u,children:D.createElement(D.Fragment,null,n&&t?n:o)},slot:l,defaultTag:Dt,name:"ListboxSelectedOption"}))}let It=j(gt),Ct=j(St),Ft=ut,Mt=j(At),wt=j(ht),Bt=j(_t),Po=Object.assign(It,{Button:Ct,Label:Ft,Options:Mt,Option:wt,SelectedOption:Bt});export{Po as Listbox,Ct as ListboxButton,Ft as ListboxLabel,wt as ListboxOption,Mt as ListboxOptions,Bt as ListboxSelectedOption};
